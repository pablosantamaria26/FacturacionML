<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>Mercado Limpio ‚Äî Facturaci√≥n M√≥vil</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b162a;
      --card2:#0f1f3a;
      --txt:#e5e7eb;
      --muted:#94a3b8;
      --line:#1f2a44;
      --accent:#3b82f6;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --white:#ffffff;
      --shadow: 0 16px 30px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% 0%, #14244a 0%, #0b1220 55%, #070c16 100%);
      color:var(--txt);
      -webkit-font-smoothing:antialiased;
      padding-bottom: 78px; /* bottom nav */
    }

    a{color:inherit}
    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 0 14px;
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(11,18,32,.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148,163,184,.12);
      padding: 14px 14px;
      margin: -18px -14px 14px -14px;
    }
    .topbar-row{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:900; letter-spacing:.4px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.25);
      border-radius:999px;
      color:var(--muted);
      background: rgba(15,23,42,.5);
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(15,23,42,.92) 0%, rgba(11,22,42,.92) 100%);
      border: 1px solid rgba(148,163,184,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.55);
    }
    .card-h h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.35px;
      text-transform: uppercase;
      color: #cbd5e1;
    }
    .card-b{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 260px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Inputs */
    .input, select, textarea{
      width:100%;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color: var(--txt);
      outline: none;
      font-size: 14px;
    }
    textarea{min-height:88px; resize:vertical}
    .input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.7);
      box-shadow: 0 0 0 4px rgba(59,130,246,.15);
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px 2px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    /* Buttons */
    .btn{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.55);
      color: var(--txt);
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.45)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95)); border-color: rgba(59,130,246,.65)}
    .btn.ok{background: linear-gradient(180deg, rgba(16,185,129,.95), rgba(5,150,105,.95)); border-color: rgba(16,185,129,.65)}
    .btn.bad{background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(220,38,38,.95)); border-color: rgba(239,68,68,.65)}
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
    .btn.w100{width:100%}

    /* Chips / tabs */
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.25);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      color:#cbd5e1;
    }
    .chip.active{
      background: rgba(59,130,246,.22);
      border-color: rgba(59,130,246,.65);
      color: #e0f2fe;
    }

    /* Inbox list */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.20);
      border-radius: 14px;
      padding: 12px;
    }
    .item-top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .item-title{font-weight:900}
    .item-sub{color:var(--muted); font-size:12px; margin-top:4px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      color:#cbd5e1;
      background: rgba(15,23,42,.45);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(16,185,129,.55); background: rgba(16,185,129,.12); color:#a7f3d0}
    .pill.warn{border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12); color:#fde68a}
    .pill.bad{border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12); color:#fecaca}
    .hr{height:1px; background: rgba(148,163,184,.14); margin: 10px 0}

    /* Audit */
    .audit{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .audit-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.18);
      font-size: 13px;
    }
    .audit-row strong{font-weight:900}
    .audit-tag{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      color:#cbd5e1;
    }
    .audit-tag.ok{border-color: rgba(16,185,129,.65); background: rgba(16,185,129,.14); color:#a7f3d0}
    .audit-tag.warn{border-color: rgba(245,158,11,.65); background: rgba(245,158,11,.14); color:#fde68a}
    .audit-tag.bad{border-color: rgba(239,68,68,.65); background: rgba(239,68,68,.14); color:#fecaca}

    /* Items editor */
    .items{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .it{
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.18);
      border-radius: 14px;
      padding: 10px;
    }
    .it-grid{
      display:grid;
      grid-template-columns: 1fr 86px 110px;
      gap:8px;
    }
    .it-grid .input{padding:12px 10px; border-radius:12px}
    .it-actions{
      display:flex; gap:8px; margin-top:10px;
    }

    /* Preview */
    .preview{
      border: 1px solid rgba(148,163,184,.14);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(2,6,23,.18);
    }
    .iframe{
      width:100%;
      height: 900px;
      border:0;
      background: transparent;
    }
    @media (max-width: 520px){
      .iframe{height: 820px;}
      .it-grid{grid-template-columns: 1fr 78px 106px}
    }

    /* Bottom nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 50;
      background: rgba(11,18,32,.9);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(148,163,184,.14);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      justify-content:center;
    }
    .nav-inner{
      max-width:980px;
      width:100%;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .navbtn{
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.55);
      color:#cbd5e1;
      border-radius: 14px;
      padding: 10px 8px;
      text-align:center;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .navbtn.active{
      border-color: rgba(59,130,246,.65);
      background: rgba(59,130,246,.18);
      color:#e0f2fe;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 90px;
      z-index: 80;
      min-width: 260px;
      max-width: 92vw;
      background: rgba(2,6,23,.88);
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
      display:none;
    }
    .toast.show{display:block}
    .toast .t{font-weight:900}
    .toast .d{color:var(--muted); font-size:12px; margin-top:3px; white-space: pre-line}

    /* Modal */
    .modal{
      position: fixed;
      inset:0;
      z-index: 90;
      display:none;
      background: rgba(0,0,0,.55);
      padding: 18px;
    }
    .modal.show{display:flex; align-items:flex-end; justify-content:center;}
    .modal-card{
      max-width: 980px;
      width: 100%;
      border-radius: 18px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.16);
      box-shadow: 0 24px 48px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-h{
      padding: 14px 14px;
      border-bottom: 1px solid rgba(148,163,184,.14);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modal-b{padding: 14px}
    .modal-h strong{font-weight:900}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-row">
      <div class="brand">
        <div style="width:38px;height:38px;border-radius:14px;background:rgba(59,130,246,.18);border:1px solid rgba(59,130,246,.35);display:flex;align-items:center;justify-content:center;font-weight:900;">ML</div>
        <div>
          <div style="font-size:14px;font-weight:900;letter-spacing:.35px;">Mercado Limpio</div>
          <div class="muted small">Facturaci√≥n m√≥vil ‚Ä¢ Inbox + Auditor + Emisi√≥n</div>
        </div>
      </div>
      <div class="badge" id="badgeApi">API: ‚Äî</div>
    </div>
  </div>

  <div class="app">
    <!-- PAGE: INBOX -->
    <section id="pageInbox" class="page">
      <div class="card">
        <div class="card-h">
          <h2>Inbox de Remitos (PDF)</h2>
          <div class="row" style="gap:8px">
            <button class="btn ghost" id="btnSyncInbox" title="Recalcular grupos">‚Üª</button>
            <button class="btn bad" id="btnClearInbox" title="Borrar todo el inbox">üß® Vaciar</button>
          </div>
        </div>
        <div class="card-b">
          <div class="row">
            <div class="col">
              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Agregar PDFs</div>
                    <div class="item-sub">Se guardan en el tel√©fono (IndexedDB). Luego se agrupan por CUIT.</div>
                  </div>
                  <span class="pill" id="pillInboxCount">0 PDFs</span>
                </div>
                <div class="hr"></div>
                <div class="row">
                  <button class="btn primary" id="btnAddPdfs">‚ûï Cargar PDFs</button>
                  <button class="btn" id="btnParseAll">‚ö° Parsear pendientes</button>
                  <input id="fileInput" type="file" accept="application/pdf" multiple hidden />
                </div>
                <div class="small muted" style="margin-top:10px">
                  Tip: pod√©s seleccionar varios PDFs. Si son de diferentes CUIT, quedar√°n en distintos grupos.
                </div>
              </div>
            </div>
            <div class="col">
              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Modo Lote</div>
                    <div class="item-sub">Seleccion√° un grupo (CUIT) ‚Üí eleg√≠ remitos ‚Üí ‚ÄúPreparar factura‚Äù.</div>
                  </div>
                  <span class="pill ok">Anti-pifiada</span>
                </div>
                <div class="hr"></div>
                <div class="audit" id="inboxHint">
                  <div class="audit-row">
                    <div><strong>1)</strong> Carg√° PDFs</div>
                    <span class="audit-tag ok">OK</span>
                  </div>
                  <div class="audit-row">
                    <div><strong>2)</strong> Parse√° para detectar CUIT/total</div>
                    <span class="audit-tag warn">Recomendado</span>
                  </div>
                  <div class="audit-row">
                    <div><strong>3)</strong> Arm√° factura desde un CUIT</div>
                    <span class="audit-tag ok">OK</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="box-shadow:none">
            <div class="card-h">
              <h2>Grupos por CUIT</h2>
              <span class="pill" id="pillGroups">0 grupos</span>
            </div>
            <div class="card-b">
              <div id="groupsList" class="list"></div>
              <div id="emptyGroups" class="muted small" style="display:none; padding:10px 2px;">
                No hay PDFs todav√≠a. Toc√° ‚ÄúCargar PDFs‚Äù.
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PAGE: FACTURAR -->
    <section id="pageFactura" class="page" style="display:none">
      <div class="card">
        <div class="card-h">
          <h2>Preparar y Emitir</h2>
          <div class="row" style="gap:8px">
            <button class="btn" id="btnBackToInbox">‚Üê Inbox</button>
            <button class="btn ghost" id="btnResetDraft" title="Reset borrador">‚Ü∫</button>
          </div>
        </div>
        <div class="card-b">
          <div class="row">
            <div class="col">
              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Datos del cliente</div>
                    <div class="item-sub">Se completa desde PDF o manual.</div>
                  </div>
                  <span class="pill" id="pillDraftMode">Borrador</span>
                </div>

                <div class="label"><span>CUIT</span><span class="muted small" id="lblClientName"></span></div>
                <input class="input mono" id="inpCuit" placeholder="CUIT (11 n√∫meros)" inputmode="numeric" />

                <div class="row">
                  <div class="col">
                    <div class="label"><span>Condici√≥n de venta</span></div>
                    <select id="selCondicion">
                      <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                      <option value="Efectivo">Efectivo</option>
                      <option value="Cheque">Cheque</option>
                    </select>
                  </div>
                  <div class="col">
                    <div class="label"><span>Email (opcional)</span><span class="muted small">si vac√≠o, usa default</span></div>
                    <input class="input" id="inpEmail" placeholder="cliente@..." inputmode="email" />
                  </div>
                </div>

                <div class="label"><span>Domicilio (Remito/AFIP)</span></div>
                <textarea id="inpDom" placeholder="Se llena desde PDF..."></textarea>

                <div class="row" style="margin-top:10px">
                  <button class="btn primary" id="btnPreviewAll">üëÅÔ∏è Vista completa</button>
                  <button class="btn" id="btnPreviewPart1">Parte 1</button>
                  <button class="btn" id="btnCopyWA">üìã Copiar WhatsApp</button>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Auditor</div>
                    <div class="item-sub">Checks autom√°ticos antes de emitir.</div>
                  </div>
                  <span class="pill" id="pillAudit">‚Äî</span>
                </div>
                <div class="hr"></div>
                <div id="auditBox" class="audit"></div>
              </div>

              <div style="height:12px"></div>

              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Modo comando (dictado)</div>
                    <div class="item-sub">‚Äúagregar 12 lavandina 1500‚Äù, ‚Äúdescuento 7‚Äù, ‚Äúcondici√≥n transferencia‚Äù, ‚Äúemitir‚Äù.</div>
                  </div>
                  <span class="pill warn">Opcional</span>
                </div>
                <div class="hr"></div>
                <div class="row">
                  <button class="btn" id="btnMic">üéôÔ∏è Dictar</button>
                  <input class="input" id="inpCmd" placeholder="o escrib√≠ un comando‚Ä¶" />
                  <button class="btn" id="btnRunCmd">‚ñ∂</button>
                </div>
                <div class="small muted" style="margin-top:8px">
                  Si el mic no aparece, es normal en algunos Android/Chrome. El modo texto funciona igual.
                </div>
              </div>

            </div>

            <div class="col">
              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">√çtems</div>
                    <div class="item-sub">Pod√©s editar manualmente. El split se calcula por cantidad (25 por parte).</div>
                  </div>
                  <span class="pill" id="pillItems">0 √≠tems</span>
                </div>
                <div class="hr"></div>

                <div class="row">
                  <button class="btn" id="btnAddItem">‚ûï √çtem</button>
                  <button class="btn" id="btnApplyDraftTotals">üßÆ Recalcular</button>
                </div>

                <div class="label">
                  <span>Resumen</span>
                  <span class="muted small" id="lblTotals"></span>
                </div>

                <div class="row">
                  <div class="col">
                    <div class="label"><span>Subtotal Bruto (Remito)</span></div>
                    <input class="input mono" id="inpSubBruto" placeholder="0,00" inputmode="decimal" />
                  </div>
                  <div class="col">
                    <div class="label"><span>Descuento %</span></div>
                    <input class="input mono" id="inpDescPct" placeholder="0" inputmode="decimal" />
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="label"><span>Descuento $</span></div>
                    <input class="input mono" id="inpDescImp" placeholder="0,00" inputmode="decimal" />
                  </div>
                  <div class="col">
                    <div class="label"><span>Total Final (post-desc)</span></div>
                    <input class="input mono" id="inpTotalFinal" placeholder="0,00" inputmode="decimal" />
                  </div>
                </div>

                <div style="height:10px"></div>
                <div id="itemsBox" class="items"></div>

                <div style="height:12px"></div>

                <button class="btn ok w100" id="btnEmitir">‚úÖ EMITIR FACTURA</button>
                <div class="small muted" style="margin-top:8px">
                  Si hay split, el backend emite N facturas y manda 1 email con N PDFs (si ten√©s Gmail configurado).
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="item">
                <div class="item-top">
                  <div>
                    <div class="item-title">Vista previa</div>
                    <div class="item-sub">Parte por parte o ‚ÄúVista completa‚Äù.</div>
                  </div>
                  <span class="pill" id="pillPreview">‚Äî</span>
                </div>
                <div class="hr"></div>

                <div class="chips" id="partsChips"></div>

                <div style="height:10px"></div>
                <div class="preview">
                  <iframe id="previewFrame" class="iframe" title="Vista previa"></iframe>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PAGE: HISTORIAL -->
    <section id="pageHist" class="page" style="display:none">
      <div class="card">
        <div class="card-h">
          <h2>Historial</h2>
          <div class="row" style="gap:8px">
            <button class="btn bad" id="btnClearHist">üß® Borrar</button>
          </div>
        </div>
        <div class="card-b">
          <div id="histList" class="list"></div>
          <div id="emptyHist" class="muted small" style="display:none; padding:10px 2px;">
            Sin historial todav√≠a.
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: AJUSTES -->
    <section id="pageSet" class="page" style="display:none">
      <div class="card">
        <div class="card-h">
          <h2>Ajustes</h2>
          <span class="pill">Render + GitHub Pages</span>
        </div>
        <div class="card-b">
          <div class="item">
            <div class="item-top">
              <div>
                <div class="item-title">API Base URL</div>
                <div class="item-sub">Por defecto: tu Render.</div>
              </div>
              <span class="pill" id="pillApiOk">‚Äî</span>
            </div>
            <div class="hr"></div>

            <div class="label">
              <span>Base URL</span>
              <span class="muted small">Ej: https://api-mercadolimpio.onrender.com</span>
            </div>
            <input class="input" id="inpApiBase" />

            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnSaveApi">Guardar</button>
              <button class="btn" id="btnPing">Probar /health</button>
            </div>

            <div class="small muted" style="margin-top:10px">
              Recomendaci√≥n: manten√© HTTPS siempre (GitHub Pages ya lo es).
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="item">
            <div class="item-top">
              <div>
                <div class="item-title">Tips de uso</div>
                <div class="item-sub">Operaci√≥n real r√°pida.</div>
              </div>
              <span class="pill ok">Pro</span>
            </div>
            <div class="hr"></div>
            <ul class="small muted" style="margin:0; padding-left:16px; line-height:1.6">
              <li>Para descuentos globales correctos con m√∫ltiples remitos: siempre ‚ÄúPreparar factura‚Äù desde un CUIT.</li>
              <li>Vista completa usa <span class="mono">previewParte:"ALL"</span>.</li>
              <li>WhatsApp se abre con <span class="mono">waLink</span> que devuelve tu backend.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="navbtn active" data-nav="inbox">üì• Inbox</div>
      <div class="navbtn" data-nav="factura">üßæ Facturar</div>
      <div class="navbtn" data-nav="hist">üïò Historial</div>
      <div class="navbtn" data-nav="set">‚öôÔ∏è Ajustes</div>
    </div>
  </nav>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t" id="toastT">‚Äî</div>
    <div class="d" id="toastD">‚Äî</div>
  </div>

  <!-- Modal: Group -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-h">
        <strong id="modalTitle">Grupo</strong>
        <button class="btn" id="btnCloseModal">Cerrar</button>
      </div>
      <div class="modal-b">
        <div class="small muted" id="modalSub">Seleccion√° remitos del mismo CUIT y prepar√° factura.</div>
        <div style="height:10px"></div>

        <div class="row">
          <button class="btn primary" id="btnPrepareFromGroup">üß† Preparar factura</button>
          <button class="btn bad" id="btnDeleteSelected">üóëÔ∏è Borrar seleccionados</button>
        </div>

        <div style="height:12px"></div>

        <div id="modalList" class="list"></div>
        <div id="modalEmpty" class="muted small" style="display:none">Este grupo no tiene PDFs.</div>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
